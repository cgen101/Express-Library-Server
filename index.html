<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Capstone- full-stack library database</title>
    <link rel="stylesheet" href="capstone-style.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,100..1000&display=swap');
        </style>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const ShowHomePage = ({onCheckOut, onReturnClick, onEditClick}) => {
            const [availableBooks, setAvailableBooks] = useState([]);
            useEffect(() => {
                fetch('http://localhost:3000/books?avail=true')
                .then((response) => response.json())
                .then((data) => {
                setAvailableBooks(data);
            })
            .catch((error) => console.error('Error fetching available books:', error));
            }, []);

            return (
                <div className="actionPage">
                    <div className="header">
                        <div className="logo">
                            <div>
                            <img src="lib.png" height="40px" width="40px"></img>
                            </div>
                            <div>
                            <h1>ibro</h1>
                            </div>
                        </div>
                        <div className="buttons">
                                <button onClick={onReturnClick}>Return A Book</button>
                                <button onClick={onEditClick}>Edit database</button>
                        </div>
                    </div>
                    <div className="title">
                        <h1>Available Books</h1>
                    </div>
                    <div className="bookList">
                        <table>
                            <tbody>
                            <tr className="theading">
                                <th>Title</th>
                                <th>Author</th>
                                <th>Publisher</th>
                                <th></th>
                            </tr>
                            {availableBooks.map((book) => (
                            <tr key={book.id}>
                                <td>{book.title}</td>
                                <td>{book.author}</td>
                                <td>{book.publisher}</td>
                                <td>
                                <button onClick={() => onCheckOut(book.id)}>Check Out</button>
                                </td>
                            </tr>
                            ))}
                        </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const ShowUnavailableBooks = ({ onReturn, onBackToHome }) => {
            const [unavailableBooks, setUnavailableBooks] = useState([]);
            useEffect(() => {
                fetch('http://localhost:3000/books?avail=false')
                .then((response) => response.json())
                .then((data) => {
                setUnavailableBooks(data);
            })
            .catch((error) => console.error('Error fetching unavailable books:', error));
            }, []);

            return (
                <div className="actionPage">
                    <div className="header">
                        <h1>library</h1>
                        <div className="buttons"> 
                                <button onClick={onBackToHome}>Go Back</button>
                        </div>
                    </div>
                    <div className="title">
                        <h1>Return a Book</h1>
                    </div>
                    <div className="bookList">
                        <table>
                        <tbody>
                            <tr className="theading">
                                <th>Title</th>
                                <th>Author</th>
                                <th>Publisher</th>
                                <th>Due date</th>
                                <th></th>
                            </tr>
                            {unavailableBooks.map((book) => (
                            <tr key={book.id}>
                                <td>{book.title}</td>
                                <td>{book.author}</td>
                                <td>{book.publisher}</td>
                                <td>{book.due}</td>
                                <td>
                                    <button onClick={() => onReturn(book.id)}>Return</button>
                                </td>
                            </tr>
                            ))}
                        </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const ShowAllBooks = ({onAddClick, onDelete, onBackToHome}) => {
            const [allBooks, setAllBooks] = useState([]);
            useEffect(() => {
                fetch('http://localhost:3000/books')
                .then((response) => response.json())
                .then((data) => {
                setAllBooks(data);
            })
            .catch((error) => console.error('Error fetching books:', error));
            }, []);

            return (
                <div className="actionPage">
                    <div className="header">
                        <h1>library</h1>
                        <div className="buttons">
                                <button onClick={onAddClick}>Add a book</button>
                                <button onClick={onBackToHome}>Go Back</button>
                        </div>
                    </div>
                    <div className="title">
                        <h1>All Books</h1>
                    </div>
                    <div className="bookList">
                        <table>
                        <tbody>
                            <tr className="theading">
                                <th>Title</th>
                                <th>Author</th>
                                <th>ISBN</th>
                                <th>Publisher</th>
                                <th>Status</th>
                                <th></th>
                            </tr>
                            {allBooks.map((book) => (
                            <tr key={book.id}>
                                <td>{book.title}</td>
                                <td>{book.author}</td>
                                <td>{book.isbn}</td>
                                <td>{book.publisher}</td>
                                <td>{bookAvailability(book)}</td>
                                <td>
                                <button onClick={() => onDelete(book.id)}>Remove</button>
                                </td>
                            </tr>
                            ))}
                        </tbody>
                        </table>
                    </div>
                    <div id="addForm" style={{display: "none"}}>
                        <form id="newBookForm">
                            <label>Title:</label>
                            <input type="text" name="title" ></input>
                            <label>Author:</label>
                            <input type="text" name="author"></input>
                            <label>ISBN:</label>
                            <input type="text" name="isbn"></input>
                            <label>Publisher:</label>
                            <input type="text" name="publisher"></input>
                            <input type="submit" value="submit"></input>
                        </form>
                    </div>
                </div>
            );
        };

        const bookAvailability = (book) => {
            if (book.avail === false) {
                return "Unavailable";
            }
            else { 
                return "Available"; 
            }
        };

        const App = () => {
            const [currentView, setCurrentView] = useState('home');

            const handleReturnClick = () => {
                setCurrentView('unavailableBooks');
            };
            const handleBackToHome = () => {
                setCurrentView('home');
            };
            const handleEditClick = () => {
                setCurrentView('edit');
            }
            const handleAddClick = () => {
                document.getElementById("addForm").style.display = "block"; 

                const form = document.getElementById("newBookForm");
                form.addEventListener('submit', function(event) {
                    event.preventDefault();
                    const formData = {};
                    const formElements = new FormData(event.target);
                    formElements.forEach((value, key) => {
                        formData[key] = value;
                    });

                    handleAdd(formData);
                });
            }


            const handleDelete = async (bookId) => {
                try {
                    const bookInfoResponse = await fetch(`http://localhost:3000/books/${bookId}`, { 
                        method: 'GET', 
                    });
                    const bookInfo = await bookInfoResponse.json();
                    const bookTitle = bookInfo.title;

                    try { 
                        const response = await fetch(`http://localhost:3000/books/${bookId}`, { 
                            method: 'DELETE', 
                        });
                        window.alert(`"${bookTitle}" deleted. Please refresh page.`);

                    } catch(error) { 
                        window.alert(`Error deleting book`);
                    }
                    
                } catch (error) {
                    window.alert(`Error deleting book`);
                }
            };

            const handleAdd = async (newBook) => {
                const response = await fetch(`http://localhost:3000/books`, { 
                        method: 'POST', 
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            title: newBook.title,
                            author: newBook.author,
                            isbn: newBook.isbn,
                            publisher: newBook.publisher ,
                            avail: true,
                            who: null,
                            due: null,
                        }),
                });
                if (response.ok) {console.log("you did it");}
                else{console.log("failed");}
            };

            const handleCheckOut = async (bookId) => {
                let userName;
                userName = prompt("Please enter your name:");
                
                if (userName) {
                try { 
                    const response= await fetch(`http://localhost:3000/books/${bookId}`, { 
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            avail: false,
                            who: userName,
                            due: '9/9/99',
                        }),
                    });      
                    if (response.ok) {         
                    const bookInfoResponse = await fetch(`http://localhost:3000/books/${bookId}`, { 
                        method: 'GET', 
                    });
                        if (bookInfoResponse.ok) {
                            const bookInfo = await bookInfoResponse.json();
                            const bookTitle = bookInfo.title;
                            const returnDate = bookInfo.due; 
                        window.alert(`"${bookTitle}" checked out successfully for ${userName}. 
                            Return by ${returnDate}. Please refresh page.`);
                        } else { 
                            console.error('Error checking out the book:', response.status);
                            window.alert('Error checking out book.');
                        }
                    } else {
                        console.error('Error checking out the book:', response.status);
                        window.alert('Error checking out book.');
                    }
                } catch (error) {
                    console.error('Error checking out the book:', error);
                }
            } else { 
                window.alert('Error checking out book.')
            }
            };

            const handleReturn = async (bookId) => {
                try { 
                    const response= await fetch(`http://localhost:3000/books/${bookId}`, { 
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            avail: true,
                            who: null,
                            due: null,
                        }),
                    });               

                    if (response.ok) {
                        const bookInfoResponse = await fetch(`http://localhost:3000/books/${bookId}`, { 
                        method: 'GET', 
                    });
                        if (bookInfoResponse.ok) {
                            const bookInfo = await bookInfoResponse.json();
                            const bookTitle = bookInfo.title;
                            const returnDate = bookInfo.due; 
                            window.alert(`"${bookTitle}" returned successfully. Please refresh page.`);
                        } else { 
                            console.error('Error returning book:', response.status);
                            window.alert('Error returning book.');
                        }
                    } else {
                        console.error('Error returning', response.status);
                        window.alert('Error returning book.');
                    }
                } catch (error) {
                    console.error('Error returning the book:', error);
                }                       
            };

            return (
                <div>
                    {currentView === 'home' && (
                        <ShowHomePage
                        onCheckOut={handleCheckOut} 
                        onReturnClick={handleReturnClick}
                        onEditClick={handleEditClick} />
                    )}

                    {currentView === 'unavailableBooks' && (
                        <ShowUnavailableBooks 
                            onReturn={handleReturn}
                            onBackToHome={handleBackToHome} />
                    )}

                    {currentView === 'edit' && (
                        <ShowAllBooks 
                            onBackToHome={handleBackToHome} 
                            onDelete={handleDelete} 
                            onAddClick={handleAddClick}
                        />
                    )}
                </div>
            );
        };
    </script>
  </head>

  <body>
    <div id="root"></div>
    <script type="text/babel">
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>